<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni GÃ¶nderi - Paslios</title>
    <script src="js/auth-guard.js"></script>
    <script src="js/security.js"></script>
    <script src="js/data.js"></script>
    <script>
        // Enhanced authentication check with session validation
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.isAuthenticated || !window.isAuthenticated()) {
                console.warn('Authentication required for post creation');
                window.location.href = '/'?redirect=' + encodeURIComponent(window.location.href);
                return;
            }
            
            // Additional user validation
            const currentUser = window.getCurrentUser();
            if (!currentUser || !currentUser.id) {
                console.error('Invalid user session');
                localStorage.clear();
                window.location.href = '/';
                return;
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 80px;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            padding: 1.5rem 1rem 1rem 1rem;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .page-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: white;
        }

        .post-btn {
            background: white;
            color: #059669;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .post-btn:hover {
            background: #f0fdf4;
        }

        .post-btn:disabled {
            background: rgba(255,255,255,0.5);
            color: rgba(5,150,105,0.5);
            cursor: not-allowed;
        }

        /* Content */
        .content {
            padding: 20px;
        }

        /* Media Upload */
        .media-upload-section {
            margin-bottom: 20px;
        }

        .upload-options {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .upload-option {
            flex: 1;
            border: 2px dashed #e5e7eb;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-option:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .upload-option.photo {
            border-color: #3b82f6;
        }

        .upload-option.photo:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .upload-option.video {
            border-color: #ef4444;
        }

        .upload-option.video:hover {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .upload-text {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .media-preview {
            display: none;
            position: relative;
            margin-bottom: 20px;
        }

        .media-preview img, .media-preview video {
            width: 100%;
            border-radius: 16px;
            max-height: 300px;
            object-fit: cover;
        }

        .remove-media {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Text Area */
        .text-area {
            margin-bottom: 20px;
        }

        .text-area textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 16px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .text-area textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .text-area textarea::placeholder {
            color: #9ca3af;
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .char-counter.warning {
            color: #f59e0b;
        }

        .char-counter.error {
            color: #ef4444;
        }

        /* Person Tagging */
        .person-tagging {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .tag-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .tag-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .tag-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        /* Location */
        .location-section {
            margin-bottom: 20px;
        }

        .location-input {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-input:hover {
            border-color: #10b981;
        }

        .location-icon {
            color: #ef4444;
            font-size: 20px;
        }

        .location-text {
            flex: 1;
            color: #374151;
        }

        .location-text.placeholder {
            color: #9ca3af;
        }

        /* Tags */
        .tags-section {
            margin-bottom: 20px;
        }

        .tags-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .tags-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Privacy */
        .privacy-section {
            margin-bottom: 30px;
        }

        .privacy-options {
            display: flex;
            gap: 12px;
        }

        .privacy-option {
            flex: 1;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .privacy-option.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .privacy-option:hover:not(.active) {
            border-color: #10b981;
            background: #f0fdf4;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #f3f4f6;
            padding: 1rem;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            max-width: 400px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            transition: all 0.2s;
            color: #6b7280;
        }

        .nav-item.active {
            color: #10b981;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
            transition: all 0.3s ease;
            max-width: 350px;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success {
            background: #10b981;
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .toast.info {
            background: #3b82f6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-container">
            <div class="nav">
                <button class="back-btn" onclick="goBack()">â</button>
                <h1 class="page-title">Yeni GÃ¶nderi</h1>
                <button class="post-btn" id="postBtn" onclick="createPost()" disabled>PaylaÅ</button>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Media Upload -->
        <div class="media-upload-section">
            <div class="upload-options">
                <div class="upload-option photo" onclick="document.getElementById('photoInput').click()">
                    <div class="upload-icon">ð·</div>
                    <div class="upload-text">FotoÄraf</div>
                    <input type="file" id="photoInput" accept="image/*" onchange="previewMedia(event, 'photo')" style="display: none;">
                </div>
                <div class="upload-option video" onclick="document.getElementById('videoInput').click()">
                    <div class="upload-icon">ð¬</div>
                    <div class="upload-text">Video</div>
                    <input type="file" id="videoInput" accept="video/*" onchange="previewMedia(event, 'video')" style="display: none;">
                </div>
            </div>
        </div>

        <div class="media-preview" id="mediaPreview">
            <img id="previewImg" src="" alt="Preview" style="display: none;">
            <video id="previewVideo" controls style="display: none; width: 100%; border-radius: 16px; max-height: 300px;">
                <source id="videoSource" src="" type="video/mp4">
            </video>
            <button class="remove-media" onclick="removeMedia()">Ã</button>
        </div>

        <!-- Text Area -->
        <div class="text-area">
            <textarea 
                id="postText" 
                placeholder="Neler oluyor? MaÃ§Ä±ndan, antrenmanÄ±ndan veya saha deneyiminden bahset..."
                maxlength="500"
                oninput="updateCharCounter(); validateForm()"
            ></textarea>
            <div class="char-counter" id="charCounter">0/500</div>
        </div>

        <!-- Person Tagging -->
        <div class="person-tagging">
            <div class="section-title">KiÅi Etiketle</div>
            <input 
                type="text" 
                class="tag-input" 
                id="personTags"
                placeholder="ArkadaÅlarÄ±nÄ± etiketle... (@username)"
                oninput="validateForm()"
            >
            <div class="tag-hint">@ kullanarak arkadaÅlarÄ±nÄ± etiketleyebilirsin</div>
        </div>

        <!-- Location -->
        <div class="location-section">
            <div class="section-title">Konum</div>
            <div class="location-input" onclick="selectLocation()">
                <span class="location-icon">ð</span>
                <span class="location-text placeholder" id="locationText">Konum ekle</span>
            </div>
        </div>

        <!-- Tags -->
        <div class="tags-section">
            <div class="section-title">Etiketler</div>
            <input 
                type="text" 
                class="tags-input" 
                id="tagsInput"
                placeholder="#futsal #gol #antrenman"
                oninput="validateForm()"
            >
            <div class="tag-hint">VirgÃ¼lle ayÄ±rarak birden fazla etiket ekleyebilirsiniz</div>
        </div>

        <!-- Privacy -->
        <div class="privacy-section">
            <div class="section-title">Gizlilik</div>
            <div class="privacy-options">
                <div class="privacy-option active" onclick="selectPrivacy('public')">
                    ð Herkese AÃ§Ä±k
                </div>
                <div class="privacy-option" onclick="selectPrivacy('followers')">
                    ð¥ TakipÃ§ilerime
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-items">
            <a href="/home" class="nav-item">
                <span>ð </span>
                <span>Ana Sayfa</span>
            </a>
            <a href="/matches" class="nav-item">
                <span>â½</span>
                <span>MaÃ§lar</span>
            </a>
            <a href="/messages" class="nav-item">
                <span>ð</span>
                <span>Mesajlar</span>
            </a>
            <a href="/profile" class="nav-item">
                <span>ð¤</span>
                <span>Profil</span>
            </a>
        </div>
    </div>

    <script>
        let selectedLocation = null;
        let selectedPrivacy = 'public';
        
        // Load required scripts
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };

        // Initialize the page
        async function initializePage() {
            try {
                await Promise.all([
                    loadScript('js/data.js'),
                    loadScript('js/toast.js')
                ]);
                console.log('Scripts loaded successfully');
            } catch (error) {
                console.error('Error loading scripts:', error);
            }
        }

        // Call initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initializePage);
        
        function goBack() {
            window.history.back();
        }
        
        function previewMedia(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            // File size validation (max 10MB for images, 50MB for videos)
            const maxSizeImage = 10 * 1024 * 1024; // 10MB
            const maxSizeVideo = 50 * 1024 * 1024; // 50MB
            const maxSize = type === 'photo' ? maxSizeImage : maxSizeVideo;
            
            if (file.size > maxSize) {
                const maxSizeText = type === 'photo' ? '10MB' : '50MB';
                if (window.ToastManager) {
                    ToastManager.show(`Dosya boyutu Ã§ok bÃ¼yÃ¼k! Maksimum ${maxSizeText} olmalÄ±dÄ±r.`, 'error');
                }
                event.target.value = ''; // Clear the input
                return;
            }
            
            // File type validation
            const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            const validVideoTypes = ['video/mp4', 'video/webm', 'video/ogg'];
            const validTypes = type === 'photo' ? validImageTypes : validVideoTypes;
            
            if (!validTypes.includes(file.type)) {
                const allowedFormats = type === 'photo' ? 'JPEG, PNG, GIF, WebP' : 'MP4, WebM, OGG';
                if (window.ToastManager) {
                    ToastManager.show(`GeÃ§ersiz dosya formatÄ±! Ä°zin verilen formatlar: ${allowedFormats}`, 'error');
                }
                event.target.value = ''; // Clear the input
                return;
            }
            
            // Security: Check file name for malicious patterns
            const fileName = file.name.toLowerCase();
            const maliciousPatterns = ['.php', '.js', '.html', '.exe', '.bat', '.sh'];
            const hasMaliciousPattern = maliciousPatterns.some(pattern => fileName.includes(pattern));
            
            if (hasMaliciousPattern) {
                if (window.ToastManager) {
                    ToastManager.show('GÃ¼venlik nedeniyle bu dosya tipi yÃ¼klenemez!', 'error');
                }
                event.target.value = ''; // Clear the input
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'photo') {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('previewImg').style.display = 'block';
                    document.getElementById('previewVideo').style.display = 'none';
                } else {
                    document.getElementById('videoSource').src = e.target.result;
                    document.getElementById('previewVideo').style.display = 'block';
                    document.getElementById('previewImg').style.display = 'none';
                    document.getElementById('previewVideo').load();
                }
                
                document.querySelector('.media-upload-section').style.display = 'none';
                document.getElementById('mediaPreview').style.display = 'block';
                validateForm();
            };
            
            reader.onerror = function() {
                if (window.ToastManager) {
                    ToastManager.show('Dosya okuma hatasÄ±! LÃ¼tfen baÅka bir dosya seÃ§in.', 'error');
                }
                event.target.value = ''; // Clear the input
            };
            
            reader.readAsDataURL(file);
        }
        
        function removeMedia() {
            document.getElementById('photoInput').value = '';
            document.getElementById('videoInput').value = '';
            document.querySelector('.media-upload-section').style.display = 'block';
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('previewVideo').style.display = 'none';
            validateForm();
        }
        
        function selectLocation() {
            const locations = [
                'Futbol Plus HalÄ±saha - BahÃ§elievler',
                'Arena Spor Kompleksi - BeÅiktaÅ',
                'Goal Futsal Center - KadÄ±kÃ¶y',
                'Champions League SahasÄ± - ÅiÅli',
                'Victory Sports Club - ÃskÃ¼dar'
            ];
            
            const location = locations[Math.floor(Math.random() * locations.length)];
            selectedLocation = location;
            
            const locationText = document.getElementById('locationText');
            locationText.textContent = location;
            locationText.classList.remove('placeholder');
            
            validateForm();
        }
        
        function selectPrivacy(type) {
            selectedPrivacy = type;
            document.querySelectorAll('.privacy-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function updateCharCounter() {
            const text = document.getElementById('postText').value;
            const counter = document.getElementById('charCounter');
            const length = text.length;
            
            counter.textContent = `${length}/500`;
            
            if (length > 450) {
                counter.classList.add('warning');
                counter.classList.remove('error');
            } else if (length >= 500) {
                counter.classList.add('error');
                counter.classList.remove('warning');
            } else {
                counter.classList.remove('warning', 'error');
            }
        }
        
        function validateForm() {
            const text = document.getElementById('postText').value.trim();
            const hasMedia = document.getElementById('mediaPreview').style.display === 'block';
            const postBtn = document.getElementById('postBtn');
            
            // Enhanced validation
            const isValidText = text.length > 0 && text.length <= 500;
            const hasContent = isValidText || hasMedia;
            
            // Additional content quality check
            const isOnlyWhitespace = text && /^\s*$/.test(text);
            const isOnlySpecialChars = text && /^[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]*$/.test(text);
            
            if (hasContent && !isOnlyWhitespace && !isOnlySpecialChars) {
                postBtn.disabled = false;
                postBtn.textContent = 'PaylaÅ';
            } else {
                postBtn.disabled = true;
                postBtn.textContent = hasContent ? 'GeÃ§erli iÃ§erik girin' : 'PaylaÅ';
            }
        }
        
        function createPost() {
            // Authentication check
            if (!window.isAuthenticated || !window.isAuthenticated()) {
                if (window.ToastManager) {
                    ToastManager.show('GÃ¶nderi paylaÅmak iÃ§in giriÅ yapmalÄ±sÄ±nÄ±z!', 'error');
                }
                setTimeout(() => window.location.href = '/', 1500);
                return;
            }
            
            const text = document.getElementById('postText').value.trim();
            const personTags = document.getElementById('personTags').value.trim();
            const tags = document.getElementById('tagsInput').value.trim();
            const hasMedia = document.getElementById('mediaPreview').style.display === 'block';
            const postBtn = document.getElementById('postBtn');
            
            // Enhanced content validation
            if (text.length === 0 && !hasMedia) {
                if (window.ToastManager) {
                    ToastManager.show('LÃ¼tfen bir metin yazÄ±n veya medya ekleyin.', 'error');
                }
                return;
            }
            
            // Text length validation
            if (text.length > 500) {
                if (window.ToastManager) {
                    ToastManager.show('Metin Ã§ok uzun! Maksimum 500 karakter olmalÄ±dÄ±r.', 'error');
                }
                return;
            }
            
            // Content quality validation
            if (text && /^\s*$/.test(text)) {
                if (window.ToastManager) {
                    ToastManager.show('Sadece boÅluk karakteri iÃ§eren gÃ¶nderiler paylaÅÄ±lamaz.', 'error');
                }
                return;
            }
            
            if (text && /^[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]*$/.test(text)) {
                if (window.ToastManager) {
                    ToastManager.show('LÃ¼tfen anlamlÄ± bir iÃ§erik yazÄ±n.', 'error');
                }
                return;
            }
            
            // Input sanitization
            const sanitizedText = window.SecurityUtils ? window.SecurityUtils.sanitizeInput(text) : text;
            const sanitizedPersonTags = window.SecurityUtils ? window.SecurityUtils.sanitizeInput(personTags) : personTags;
            const sanitizedTags = window.SecurityUtils ? window.SecurityUtils.sanitizeInput(tags) : tags;
            
            // Show loading state
            postBtn.disabled = true;
            postBtn.textContent = 'PaylaÅÄ±lÄ±yor...';
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                
                const postData = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    username: currentUser.username,
                    userAvatar: currentUser.avatar || 'ð¤',
                    text: sanitizedText,
                    personTags: sanitizedPersonTags,
                    location: selectedLocation,
                    tags: sanitizedTags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    privacy: selectedPrivacy,
                    hasMedia: hasMedia,
                    mediaType: hasMedia ? (document.getElementById('previewImg').style.display === 'block' ? 'image' : 'video') : null,
                    likes: 0,
                    comments: 0,
                    shares: 0,
                    timestamp: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };
                
                // Yeni gÃ¶nderi oluÅturma sistemi
                const result = pasliosData.createPost(sanitizedText, 'text');
                
                if (result.success) {
                    if (window.ToastManager) {
                        ToastManager.show('GÃ¶nderiniz baÅarÄ±yla paylaÅÄ±ldÄ±! ð', 'success');
                    }
                    
                    // Wait for toast to show, then redirect
                    setTimeout(() => {
                        window.location.href = '/home';
                    }, 1500);
                } else {
                    if (window.ToastManager) {
                        ToastManager.show(result.message, 'error');
                    }
                    
                    // Reset button state
                    postBtn.disabled = false;
                    postBtn.textContent = 'PaylaÅ';
                }
                
            } catch (error) {
                console.error('Error creating post:', error);
                if (window.ToastManager) {
                    ToastManager.show('GÃ¶nderi paylaÅÄ±lÄ±rken bir hata oluÅtu.', 'error');
                }
                postBtn.disabled = false;
                postBtn.textContent = 'PaylaÅ';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            validateForm();
        });
    </script>
</body>
</html>
