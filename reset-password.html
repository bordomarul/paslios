<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Paslios - Yeni Şifre Belirle">
    <link href="output.css" rel="stylesheet">`n    <link href="css/responsive.css" rel="stylesheet">
    <title>Paslios - Yeni Şifre</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      
      .container {
        width: 100%;
        max-width: 400px;
      }
      
      .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        padding: 2rem;
        text-align: center;
      }
      
      .logo {
        width: 4rem;
        height: 4rem;
        background: linear-gradient(135deg, #10b981, #059669);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      
      .logo svg {
        width: 2rem;
        height: 2rem;
        color: white;
      }
      
      .title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #374151;
        margin-bottom: 0.5rem;
      }
      
      .subtitle {
        color: #6b7280;
        margin-bottom: 2rem;
        line-height: 1.5;
      }
      
      .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
      }
      
      .form-label {
        display: block;
        color: #374151;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }
      
      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.2s;
        background-color: #f9fafb;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #10b981;
        background-color: white;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      }
      
      .btn-primary {
        width: 100%;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 0.875rem;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1rem;
      }
      
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
      }
      
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .back-link {
        color: #6b7280;
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.2s;
      }
      
      .back-link:hover {
        color: #10b981;
      }
      
      .success-message {
        background: #d1fae5;
        border: 1px solid #a7f3d0;
        color: #065f46;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        display: none;
      }
      
      .error-message {
        background: #fee2e2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        display: none;
      }
      
      .password-strength {
        margin-top: 0.5rem;
        font-size: 0.875rem;
      }
      
      .strength-weak { color: #dc2626; }
      .strength-medium { color: #d97706; }
      .strength-strong { color: #059669; }
      
      .password-requirements {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.5rem;
        text-align: left;
      }
      
      .password-requirements ul {
        list-style: none;
        padding: 0;
      }
      
      .password-requirements li {
        margin-bottom: 0.25rem;
      }
      
      .password-requirements .valid {
        color: #059669;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
        </div>
        
        <h1 class="title">Yeni Şifre Belirle</h1>
        <p class="subtitle">
          Hesabınız için güvenli bir şifre oluşturun.
        </p>
        
        <div id="successMessage" class="success-message">
          <strong>✅ Başarılı!</strong> Şifreniz güncellendi. Giriş sayfasına yönlendiriliyorsunuz...
        </div>
        
        <div id="errorMessage" class="error-message">
          <strong>❌ Hata!</strong> <span id="errorText">Bir hata oluştu.</span>
        </div>
        
        <form id="resetPasswordForm">
          <div class="form-group">
            <label for="newPassword" class="form-label">Yeni Şifre</label>
            <input 
              type="password" 
              id="newPassword" 
              name="newPassword" 
              class="form-input" 
              placeholder="Yeni şifrenizi girin"
              required
              minlength="6"
            >
            <div id="passwordStrength" class="password-strength"></div>
            <div class="password-requirements">
              <ul>
                <li id="length">• En az 6 karakter</li>
                <li id="letter">• En az bir harf</li>
                <li id="number">• En az bir rakam</li>
              </ul>
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword" class="form-label">Şifre Tekrarı</label>
            <input 
              type="password" 
              id="confirmPassword" 
              name="confirmPassword" 
              class="form-input" 
              placeholder="Şifrenizi tekrar girin"
              required
            >
          </div>
          
          <button type="submit" class="btn-primary" id="updateButton">
            Şifremi Güncelle
          </button>
        </form>
        
        <a href="/index" class="back-link">
          ← Giriş sayfasına dön
        </a>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('resetPasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const updateButton = document.getElementById('updateButton');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const passwordStrength = document.getElementById('passwordStrength');

        // URL'den token'ı al
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Token yoksa veya geçersizse ana sayfaya yönlendir
        if (!token || !isValidToken(token)) {
          showError('Geçersiz veya süresi dolmuş bağlantı.');
          setTimeout(() => {
            window.location.href = '/';
          }, 3000);
          return;
        }

        // Şifre gücü kontrolü
        newPasswordInput.addEventListener('input', function() {
          const password = this.value;
          checkPasswordStrength(password);
          updatePasswordRequirements(password);
        });

        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;
          
          if (!newPassword || !confirmPassword) {
            showError('Lütfen tüm alanları doldurun.');
            return;
          }
          
          if (newPassword.length < 6) {
            showError('Şifre en az 6 karakter olmalıdır.');
            return;
          }
          
          if (newPassword !== confirmPassword) {
            showError('Şifreler eşleşmiyor.');
            return;
          }
          
          // Butonu devre dışı bırak
          updateButton.disabled = true;
          updateButton.textContent = 'Güncelleniyor...';
          
          try {
            const resetData = JSON.parse(localStorage.getItem('paslios_reset_token') || '{}');
            
            if (resetData.token === token) {
              // Kullanıcıyı bul ve şifresini güncelle
              const users = JSON.parse(localStorage.getItem('paslios_users') || '[]');
              const userIndex = users.findIndex(user => 
                user.email.toLowerCase() === resetData.email.toLowerCase()
              );
              
              if (userIndex !== -1) {
                // Şifreyi hashle (basit bir hash, gerçek uygulamada bcrypt kullanılmalı)
                users[userIndex].password = btoa(newPassword); // Base64 encoding
                
                // Kullanıcı listesini güncelle
                localStorage.setItem('paslios_users', JSON.stringify(users));
                
                // Reset token'ı sil
                localStorage.removeItem('paslios_reset_token');
                
                // Başarı mesajı göster
                showSuccess();
                
                // 3 saniye sonra giriş sayfasına yönlendir
                setTimeout(() => {
                  window.location.href = '/';
                }, 3000);
                
              } else {
                showError('Kullanıcı bulunamadı.');
              }
            } else {
              showError('Geçersiz token.');
            }
            
          } catch (error) {
            showError('Bir hata oluştu. Lütfen tekrar deneyin.');
          } finally {
            updateButton.disabled = false;
            updateButton.textContent = 'Şifremi Güncelle';
          }
        });
        
        function isValidToken(token) {
          try {
            const resetData = JSON.parse(localStorage.getItem('paslios_reset_token') || '{}');
            return resetData.token === token && resetData.expires > Date.now();
          } catch {
            return false;
          }
        }
        
        function checkPasswordStrength(password) {
          let strength = 0;
          let text = '';
          let className = '';
          
          if (password.length >= 6) strength++;
          if (/[a-zA-Z]/.test(password)) strength++;
          if (/\d/.test(password)) strength++;
          if (/[^a-zA-Z\d]/.test(password)) strength++;
          
          if (strength < 2) {
            text = 'Zayıf';
            className = 'strength-weak';
          } else if (strength < 3) {
            text = 'Orta';
            className = 'strength-medium';
          } else {
            text = 'Güçlü';
            className = 'strength-strong';
          }
          
          passwordStrength.textContent = password ? `Şifre gücü: ${text}` : '';
          passwordStrength.className = `password-strength ${className}`;
        }
        
        function updatePasswordRequirements(password) {
          const lengthEl = document.getElementById('length');
          const letterEl = document.getElementById('letter');
          const numberEl = document.getElementById('number');
          
          lengthEl.className = password.length >= 6 ? 'valid' : '';
          letterEl.className = /[a-zA-Z]/.test(password) ? 'valid' : '';
          numberEl.className = /\d/.test(password) ? 'valid' : '';
        }
        
        function showSuccess() {
          successMessage.style.display = 'block';
          errorMessage.style.display = 'none';
        }
        
        function showError(message) {
          errorText.textContent = message;
          errorMessage.style.display = 'block';
          successMessage.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
